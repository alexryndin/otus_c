# HW11
## Требования к сборке
Наличие GNU make.
## Как собрать
```
make
```
## Как собрать с дебагом
```
make dev
```
## Как запускать
```
Usage: Usage: ./main num_of_workers block_size [glob]
```
num_of_worker -- количество воркеров.
block_size -- размер обрабатываемого блока в мегабайтах.
glob -- опциональный глоб к логам. По дефолту это `*.log.[0-9]`.

## Фичи, особенности
* Воркеры обрабатывают отдельные кусочки, переданные на обработку, а не файл
целиков. Предпосылки к такой реализации состоят в том, что файлы могут быть
сильно разного размера, из-за чего некоторые воркеры могут заканчивать работу
раньше. Если же они обрабатывают небольшие кусочки равного размера, то
вероятность, что они будут работать параллельно на мой вгляд выше.
* Воркеры открывают файл единожды, и закрывают только когда новая джоба требует
обращения к другому файлу.
* Общение мастера с воркерами происходит через каналы. Очень люблю го, поэтому
над тем как организовать общение долго не думал. Среди вариантов были
рассматриваемые на занятии linux-очереди, но через них, если я правильно помню,
можно передавать лишь raw байты, откуда следом встаёт вопрос чтения в структуру
и прочие неприятности. Реализацию каналов честно стырил :)
* Мастер высчитывает блок, который должен будет обработать воркер, и немного
расширяет его до переноса строки. Таким образом блок, обрабатываемый воркером,
почти всегда шире размера блока, указанного в командной строке.
* Подсчёт байтиков происходит через хэш-мапу, реализованную в hw3. Чё коду
пропадать :)))
* Приложение показывает своего рода статус -- текущий "поглащаемый" файл.
* Zero copy -- воркеры при обработке строк не копируют их, а двигают указатели
на считанный блок.

# А можно быстрее?
Изначально в этом домашнем задании я планировал применить джедайскую технику,
ранее освоенную в hw10, а именно -- mmap файла в память, но не смог красиво
решить другую назреваемую следом проблему -- как отммапливать кусочки
прочитанной памяти таким образом, чтобы не заехать в соседний блок, выровненный
по переносам строк. Но совсем недавно я узнал ещё более джедайскую технику --
делать munmap на смапленные блоки вовсе не обязательно ;)
# Пример работы
```
time ./main 8 20 './access.log*'
./access.log.2
./access.log.3
./access.log.4
./access.log.5
./access.log.6
./access.log.7
./access.log.8
./access.log.9

Referer: -, count: 9344076
Referer: https://www.google.com/, count: 1200038
Referer: https://yandex.ru/, count: 414808
Referer: https://www.google.ru/, count: 246342
Referer: https://baneks.site/best/, count: 194708
Referer: https://baneks.site/new/, count: 100254
Referer: http://yandex.ru/searchapp?text=, count: 84240
Referer: https://baneks.site/, count: 74830
Referer: https://baneks.site/best/?p=2, count: 64942
Referer: https://www.google.com.ua/, count: 49456

Url: /sitemap.xml, sum bytes: 42504752962
Url: /best/, sum bytes: 2133096622
Url: /, sum bytes: 1776084912
Url: /new/, sum bytes: 1153080316
Url: /%D1%81%D1%82%D0%BE%D1%8F%D1%82-%D0%BF%D0%B0%D1%81%D1%81%D0%B0%D0%B6%D0%B8%D1%80%D1%8B-%D0%B2-%D0%B0%D1%8D%D1%80%D0%BE%D0%BF%D0%BE%D1%80%D1%82%D1%83-%D0%BF%D0%BE%D1%81%D0%B0%D0%B4%D0%BE%D1%87%D0%BD%D1%8B%D0%B9-%D0%B4%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80/?p=4, sum bytes: 1078666002
Url: /%D0%B4%D0%B0-%D0%B0%D0%BB%D1%91-%D0%B4%D0%B0-%D0%B4%D0%B0-%D0%BD%D1%83-%D0%BA%D0%B0%D0%BA-%D1%82%D0%B0%D0%BC-%D1%81-%D0%B4%D0%B5%D0%BD%D1%8C%D0%B3%D0%B0%D0%BC%D0%B8/, sum bytes: 853984744
Url: /%D0%B6%D0%B5%D0%BD%D1%89%D0%B8%D0%BD%D0%B0-%D0%B8-%D0%B5%D1%91-%D0%BB%D1%8E%D0%B1%D0%BE%D0%B2%D0%BD%D0%B8%D0%BA-%D0%BD%D0%B0%D1%85%D0%BE%D0%B4%D0%B8%D0%BB%D0%B8%D1%81%D1%8C-%D0%B2-%D0%B4%D0%BE%D0%BC%D0%B5-%D0%BF%D0%BE%D0%BA%D0%B0-%D0%BC%D1%83%D0%B6/, sum bytes: 763750570
Url: /%D0%B2%D1%81%D1%82%D1%80%D0%B5%D1%87%D0%B0%D0%BB%D0%B8%D1%81%D1%8C-%D1%81-%D0%B4%D0%B5%D0%B2%D1%83%D1%88%D0%BA%D0%BE%D0%B9-%D1%83%D0%B6%D0%B5-2-%D0%B3%D0%BE%D0%B4%D0%B0-%D0%B1%D1%8B%D0%BB-%D1%81%D0%B5%D0%BA%D1%81-%D0%B8/, sum bytes: 648695810
Url: /%D0%BA%D1%80%D1%83%D1%82%D0%BE%D0%B9-%D0%B4%D0%B6%D0%B0%D0%B7%D0%BE%D0%B2%D1%8B%D0%B9-%D0%B1%D0%B0%D1%80-%D0%BF%D1%80%D0%BE%D0%B2%D0%BE%D0%B4%D0%B8%D1%82-%D0%BA%D0%BE%D0%BD%D0%BA%D1%83%D1%80%D1%81/, sum bytes: 464625796
Url: /-%D0%B4%D0%B5%D0%B2%D1%83%D1%88%D0%BA%D0%B0-%D0%B2%D0%B0%D1%88%D0%B8-%D1%80%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D0%B8-%D1%81%D0%BB%D1%83%D1%87%D0%B0%D0%B9%D0%BD%D0%BE-%D0%BD%D0%B5-%D0%BE%D1%85%D0%BE%D1%82%D0%BD%D0%B8%D0%BA%D0%B8-%D0%BD%D0%B5%D1%82/, sum bytes: 458865158

Total bytes send = 279206359988
./main 8 20 './access.log*'  47.12s user 2.69s system 592% cpu 8.403 total
```
